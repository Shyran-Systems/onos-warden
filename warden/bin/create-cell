#!/bin/bash
# Creates a new cell.

name="$1"
ipx="$2"
spec="$3"
shift 3
key="$@"

cd $(dirname $0)

both=${spec%+*}
nodes=${both%+*}
cores=${both#*+}
mininet=${spec##*+}

[ $both = $nodes ] && cores=0

ssh 10.192.19.220 "grep -qF \"$key\" /home/sdn/.ssh/authorized_keys || echo $key >> /home/sdn/.ssh/authorized_keys"

if [ $mininet -ge 1 ]; then
    ./clone-node base-mininet ${ipx/x/0} $name-n "$key" &
    sleep 1
fi

let n=1
while [ $n -le $cores ]; do
    ./clone-node base-onos ${ipx/x/$n} $name-c$n "$key" &
    let n=n+1
    sleep 1
done

let a=n
let n=1
while [ $n -le $nodes ]; do
    ./clone-node base-onos ${ipx/x/$a} $name-$n "$key" &
    let n=n+1
    let a=a+1
    sleep 1
done

wait
